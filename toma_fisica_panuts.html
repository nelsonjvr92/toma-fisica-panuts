<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Toma Física Panuts</title>
<style>
  body {
    background-color: #4b0000;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 400px;
    margin: 40px auto;
    background: white;
    color: #4b0000;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.4);
  }
  h2 {
    margin-bottom: 15px;
  }
  input, button {
    width: 100%;
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 16px;
  }
  button {
    background-color: #4b0000;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }
  button:hover {
    background-color: #600000;
  }
  .desc {
    font-size: 14px;
    color: #333;
    text-align: left;
    background: #f7f7f7;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
  }
  #mensaje {
    font-weight: bold;
    margin-top: 10px;
  }
</style>
</head>
<body>
  <div class="container">
    <img src="logo_panuts_v2.png" alt="Logo Panuts" width="180">
    <h2>TOMA FÍSICA - PANUTS</h2>

    <input type="text" id="codigoInput" placeholder="Escanea código de barras" autofocus>
    
    <div id="resultado"></div>

    <input type="text" id="observacionInput" placeholder="Describe el producto" style="display:none;">
    <input type="number" id="cantidadInput" placeholder="Cantidad" min="0" value="" required>
    
    <button id="registrarBtn">Registrar</button>
    <p id="mensaje"></p>
  </div>

<script>
let productos = [];
let productoActual = null;
const urlGoogleScript = "https://script.google.com/macros/s/AKfycbxTI-ucIkdIdaJutIyHW4LgqK7C0l5GK6VlZt1rO2Z-2Rg-KX1s1v_dANAiLa8gmK2s/exec";

const mensajeDiv = document.getElementById('mensaje');
const obsInput = document.getElementById("observacionInput");

// 1️⃣ Cargar CSV automáticamente con manejo de errores
fetch("productos.csv")
  .then(res => {
    if (!res.ok) throw new Error("No se pudo encontrar el archivo productos.csv");
    return res.text();
  })
  .then(text => {
    productos = text.split("\n").slice(1).map(line => {
      const parts = line.split(",");
      return {
        codigo: parts[0]?.trim(),
        descripcion: parts[1]?.trim(),
        codigoBarras: parts[2]?.trim()
      };
    });
    mensajeDiv.textContent = `✅ CSV cargado correctamente (${productos.length} productos)`;
    console.log("Productos cargados:", productos.length);
  })
  .catch(error => {
    mensajeDiv.innerHTML = `<span style="color:red;">❌ Error: ${error.message}</span>`;
    console.error(error);
  });

// 2️⃣ Buscar producto al escribir o escanear
document.getElementById("codigoInput").addEventListener("change", e => {
  const valor = e.target.value.trim();
  const producto = productos.find(p => p.codigoBarras === valor || p.codigo === valor);
  const contenedor = document.getElementById("resultado");

  if (producto) {
    // Producto existente
    productoActual = {
      codigo: producto.codigo,      // SKU del CSV
      descripcion: producto.descripcion,
      codigoBarras: valor            // valor escaneado
    };
    contenedor.innerHTML = `
      <div class="desc">
        <strong>${producto.descripcion}</strong><br>
        Código: ${producto.codigo}<br>
        EAN escaneado: ${valor}
      </div>`;
    obsInput.style.display = "none";
    mensajeDiv.textContent = "";
    document.getElementById("cantidadInput").focus();
  } else {
    // Producto nuevo
    productoActual = {
      codigo: valor,       // usar valor escaneado como SKU
      descripcion: "",
      codigoBarras: valor  // valor escaneado
    };
    contenedor.innerHTML = "";
    obsInput.style.display = "block";
    obsInput.value = "";
    obsInput.focus();
    mensajeDiv.textContent = "❌ Producto no encontrado, ingresa descripción";
  }
});

// 3️⃣ Registrar producto en Google Sheets
document.getElementById("registrarBtn").addEventListener("click", () => {
  const cantidad = parseFloat(document.getElementById("cantidadInput").value);

  if (!productoActual) {
    alert("Primero escanea un producto válido.");
    return;
  }
  if (isNaN(cantidad) || cantidad <= 0) {
    alert("Por favor ingresa una cantidad mayor a 0.");
    return;
  }

  // Si es producto nuevo, tomar la descripción del input
  if (!productoActual.descripcion) {
    if (!obsInput.value.trim()) {
      alert("Por favor ingresa la descripción del producto nuevo.");
      return;
    }
    productoActual.descripcion = obsInput.value.trim();
  }

  fetch(urlGoogleScript + `?codigo=${productoActual.codigo}&descripcion=${encodeURIComponent(productoActual.descripcion)}&codigoBarras=${productoActual.codigoBarras}&cantidad=${cantidad}`)
    .then(res => res.text())
    .then(resp => {
      mensajeDiv.textContent = resp;
      document.getElementById("codigoInput").value = "";
      document.getElementById("cantidadInput").value = 0;
      obsInput.value = "";
      obsInput.style.display = "none";
      document.getElementById("resultado").innerHTML = "";
      document.getElementById("codigoInput").focus();
    })
    .catch(() => {
      mensajeDiv.textContent = "❌ Error al registrar";
    });
});
</script>
</body>
</html>
